package app.gui.inicio;

import app.dataStruct.Lista;
import app.logic.Main;
import app.logic.users.Paciente;
import app.logic.users.Medico;
import app.logic.users.Usuario;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import javax.swing.DefaultListModel;
import javax.swing.JOptionPane;

public class DerivarGui extends javax.swing.JFrame {

    // Atributo de lista
    private static Lista usuarios;
    private final Paciente paciente;
    private static Medico medicoEncontrado;
    // Modelo lista
    DefaultListModel dlm = new DefaultListModel();
    int id;
    int nivelUrgenciaSeleccionado;

    /**
     * Creates new form HistoriaClinica
     *
     * @param paciente
     * @param id
     */
    public DerivarGui(Paciente paciente) {
        initComponents();
        this.paciente = paciente;
        usuarios = InicioForm.getUsuarios();
        actualizarInfo();
        this.setLocationRelativeTo(null);
        lstResultados.setModel(dlm);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        aSpn2 = new javax.swing.JSpinner();
        jSeparator4 = new javax.swing.JSeparator();
        bienvenidaLabel = new javax.swing.JLabel();
        salirBtn = new javax.swing.JButton();
        sexoLbl = new javax.swing.JLabel();
        nombreLbl = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        edadLbl = new javax.swing.JLabel();
        continuarBtn = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        lstResultados = new javax.swing.JList<>();
        todosEmergenciaBtn = new javax.swing.JButton();
        todosBtn = new javax.swing.JButton();
        background = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setUndecorated(true);
        setResizable(false);
        getContentPane().setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jSeparator4.setBackground(new java.awt.Color(0, 0, 0));
        getContentPane().add(jSeparator4, new org.netbeans.lib.awtextra.AbsoluteConstraints(290, 40, 430, 20));

        bienvenidaLabel.setFont(new java.awt.Font("Roboto", 1, 24)); // NOI18N
        bienvenidaLabel.setForeground(new java.awt.Color(102, 0, 153));
        bienvenidaLabel.setText("Derivar Paciente");
        getContentPane().add(bienvenidaLabel, new org.netbeans.lib.awtextra.AbsoluteConstraints(420, 10, -1, -1));

        salirBtn.setBackground(new java.awt.Color(204, 204, 204));
        salirBtn.setFont(new java.awt.Font("Segoe UI", 1, 18)); // NOI18N
        salirBtn.setForeground(new java.awt.Color(18, 84, 136));
        salirBtn.setText("X");
        salirBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                salirBtnActionPerformed(evt);
            }
        });
        getContentPane().add(salirBtn, new org.netbeans.lib.awtextra.AbsoluteConstraints(970, 0, 50, -1));

        sexoLbl.setBackground(new java.awt.Color(51, 51, 51));
        sexoLbl.setFont(new java.awt.Font("Segoe UI", 0, 20)); // NOI18N
        sexoLbl.setForeground(new java.awt.Color(51, 51, 51));
        sexoLbl.setText("null");
        getContentPane().add(sexoLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(790, 80, 90, 30));

        nombreLbl.setBackground(new java.awt.Color(51, 51, 51));
        nombreLbl.setFont(new java.awt.Font("Segoe UI", 0, 20)); // NOI18N
        nombreLbl.setForeground(new java.awt.Color(51, 51, 51));
        nombreLbl.setText("null");
        getContentPane().add(nombreLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(220, 80, 210, 30));

        jLabel3.setFont(new java.awt.Font("Dialog", 1, 18)); // NOI18N
        jLabel3.setForeground(new java.awt.Color(0, 51, 51));
        jLabel3.setText("Sexo:");
        getContentPane().add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(730, 80, -1, 30));

        jLabel4.setFont(new java.awt.Font("Dialog", 1, 18)); // NOI18N
        jLabel4.setForeground(new java.awt.Color(0, 51, 51));
        jLabel4.setText("Nombre:");
        getContentPane().add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(130, 80, -1, 30));

        jLabel5.setFont(new java.awt.Font("Dialog", 1, 18)); // NOI18N
        jLabel5.setForeground(new java.awt.Color(0, 51, 51));
        jLabel5.setText("Edad:");
        getContentPane().add(jLabel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(570, 80, -1, 30));

        edadLbl.setBackground(new java.awt.Color(51, 51, 51));
        edadLbl.setFont(new java.awt.Font("Segoe UI", 0, 20)); // NOI18N
        edadLbl.setForeground(new java.awt.Color(51, 51, 51));
        edadLbl.setText("null");
        getContentPane().add(edadLbl, new org.netbeans.lib.awtextra.AbsoluteConstraints(630, 80, 80, 30));

        continuarBtn.setBackground(new java.awt.Color(18, 84, 136));
        continuarBtn.setFont(new java.awt.Font("Dialog", 1, 24)); // NOI18N
        continuarBtn.setForeground(new java.awt.Color(255, 255, 255));
        continuarBtn.setText("Asignar");
        continuarBtn.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        continuarBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                continuarBtnActionPerformed(evt);
            }
        });
        getContentPane().add(continuarBtn, new org.netbeans.lib.awtextra.AbsoluteConstraints(400, 510, 210, 40));

        lstResultados.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                lstResultadosMouseClicked(evt);
            }
        });
        jScrollPane2.setViewportView(lstResultados);

        getContentPane().add(jScrollPane2, new org.netbeans.lib.awtextra.AbsoluteConstraints(150, 250, 730, 240));

        todosEmergenciaBtn.setBackground(new java.awt.Color(255, 102, 102));
        todosEmergenciaBtn.setFont(new java.awt.Font("Dialog", 1, 24)); // NOI18N
        todosEmergenciaBtn.setForeground(new java.awt.Color(255, 255, 255));
        todosEmergenciaBtn.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagen/icon/search_1.png"))); // NOI18N
        todosEmergenciaBtn.setText("Mostrar todos emergencia");
        todosEmergenciaBtn.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        todosEmergenciaBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                todosEmergenciaBtnActionPerformed(evt);
            }
        });
        getContentPane().add(todosEmergenciaBtn, new org.netbeans.lib.awtextra.AbsoluteConstraints(530, 200, 350, 40));

        todosBtn.setBackground(new java.awt.Color(18, 84, 136));
        todosBtn.setFont(new java.awt.Font("Dialog", 1, 24)); // NOI18N
        todosBtn.setForeground(new java.awt.Color(255, 255, 255));
        todosBtn.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagen/icon/search_1.png"))); // NOI18N
        todosBtn.setText("Mostrar todos");
        todosBtn.setBorder(javax.swing.BorderFactory.createEtchedBorder());
        todosBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                todosBtnActionPerformed(evt);
            }
        });
        getContentPane().add(todosBtn, new org.netbeans.lib.awtextra.AbsoluteConstraints(160, 200, 200, 40));

        background.setIcon(new javax.swing.ImageIcon(getClass().getResource("/imagen/backgroundMain.jpg"))); // NOI18N
        background.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                backgroundKeyPressed(evt);
            }
        });
        getContentPane().add(background, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 1020, 560));

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void backgroundKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_backgroundKeyPressed

    }//GEN-LAST:event_backgroundKeyPressed

    private void salirBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_salirBtnActionPerformed
        this.setVisible(false);
    }//GEN-LAST:event_salirBtnActionPerformed

    private void continuarBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_continuarBtnActionPerformed
        // Obtiene los datos
        if (medicoEncontrado != null) {
            String medicoId = medicoEncontrado.getCedula();
            paciente.setIdMedicoResponsable(medicoId);

            // Actualiza en base de datos
            try {
                PreparedStatement st = Main.getConnect().prepareStatement("UPDATE paciente SET idResponsable = ? WHERE cedula = ?");
                st.setString(1, medicoId);
                st.setString(2, paciente.getCedula());
                JOptionPane.showMessageDialog(null, "Se ha asignado el paciente " + paciente.getApellido() + " al médico " + medicoEncontrado.getApellido());

                String nuevoEstado = "Proceso";
                paciente.setEstado(nuevoEstado);

                try {
                    st = Main.getConnect().prepareStatement("UPDATE paciente SET estado = ? WHERE cedula = ?");
                    st.setString(1, nuevoEstado);
                    st.setString(2, paciente.getCedula());
                } catch (SQLException ex) {
                }
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        } else {
            JOptionPane.showMessageDialog(null, "Seleccione un médico de la lista");
        }

        this.setVisible(false);
    }//GEN-LAST:event_continuarBtnActionPerformed

    private void lstResultadosMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lstResultadosMouseClicked
        // Corta el String idSeleccion en hasta encontrar un espacio
        String idSeleccion = lstResultados.getSelectedValue().substring(0, lstResultados.getSelectedValue().indexOf(" "));
        actualizarMedicoActual(idSeleccion);
    }//GEN-LAST:event_lstResultadosMouseClicked

    private void todosBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_todosBtnActionPerformed
        actualizarLista();
    }//GEN-LAST:event_todosBtnActionPerformed

    private void todosEmergenciaBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_todosEmergenciaBtnActionPerformed
        actualizarListaEmergencia();
    }//GEN-LAST:event_todosEmergenciaBtnActionPerformed

    public void actualizarLista() {
        dlm.removeAllElements();
        usuarios = InicioForm.getUsuarios();
        usuarios.getUsuarios().forEach(usuario -> {
            if (usuario.getRol().equals("Medico")) {
                dlm.addElement(usuario.toString());
            }
        });
    }

    public void actualizarListaEmergencia() {
        dlm.removeAllElements();
        usuarios = InicioForm.getUsuarios();
        usuarios.getUsuarios().forEach(usuario -> {
            if (usuario instanceof Medico) {
                if (((Medico) usuario).getEspecialidad().equals("Emergencia")) {
                    dlm.addElement(usuario.toString());
                }
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JSpinner aSpn2;
    private javax.swing.JLabel background;
    private javax.swing.JLabel bienvenidaLabel;
    private javax.swing.JButton continuarBtn;
    private javax.swing.JLabel edadLbl;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JSeparator jSeparator4;
    private javax.swing.JList<String> lstResultados;
    private javax.swing.JLabel nombreLbl;
    private javax.swing.JButton salirBtn;
    private javax.swing.JLabel sexoLbl;
    private javax.swing.JButton todosBtn;
    private javax.swing.JButton todosEmergenciaBtn;
    // End of variables declaration//GEN-END:variables

    private void actualizarMedicoActual(String idSeleccion) {
        usuarios = InicioForm.getUsuarios();
        medicoEncontrado = buscarMedico(idSeleccion);

    }

    private Medico buscarMedico(String cedula) {
        for (Usuario medico : usuarios.getUsuarios()) {
            if (medico.getCedula().equals(cedula)) {
                return (Medico) medico;
            }
        }
        return null;
    }

    private void actualizarInfo() {
        nombreLbl.setText(paciente.getNombre());
        edadLbl.setText("" + paciente.getEdad());
        sexoLbl.setText(paciente.getSexo());
    }
}
